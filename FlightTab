from playwright.async_api import Page
from datetime import datetime
import pytest

@pytest.fixture()
class roundTrip:
    
    def __init__(self, page: Page): # This is so we dont have to pass page everytime
        self.page = page            # stores page value in instance created 

    async def select_trip_type(self, trip_type):
            valid_trip_types = ["roundTrip", "oneWay"]
            if trip_type not in valid_trip_types:
                pytest.fail(f"Invalid trip type: {trip_type}")
                return
            trip_type_locator = await self.get_element(f"//button[@data-component='flight-search-type-{trip_type}']")
            if trip_type_locator:
                await trip_type_locator.click()
            else:
                pytest.fail("Cannot find trip type {trip_type} button")

    async def select_airport_options(self, Airport_name):
        # Get options in airport list
        airport_options = await self.get_element( 
            "//li[@class='Suggestion__categoryName_item']"
        )
        if not airport_options:
            pytest.fail("cannot find airport options list")
            
        count = await airport_options.count()
        for i in range (count):
            option_text = await airport_options.nth(i).text_content()

            # Select airport names from dropdown list
            if Airport_name.lower() in option_text.lower() :
                await airport_options.nth(i).click()
                return
        if count > 0 :
            await airport_options.first.click()
        else: 
            pytest.fail("No airport with this name can be found")


    # Making a function to select Airport
    async def select_airport(self, departure_Airport_name, arrival_Airport_name):

        # Get departure airport locator and fill in airport name
        departure_airport = await self.get_element("#flight-origin-search-input")
        await departure_airport.click()
        await self.page.keyboard.type(departure_Airport_name)
        # Select airport with matching name from users inputted name
        await self.select_airport_options(departure_Airport_name)
        # Fill in departure airport field
        await self.page.wait_for_timeout(1000)    
        
        #Get arrival airport locator and fill in airport name
        arrival_airport = await self.get_element("#flight-destination-search-input")
        await arrival_airport.click()
        await self.page.keyboard.type(arrival_Airport_name)
        # Select airport with matching name from users inputted name
        await self.select_airport_options(arrival_Airport_name)
        # Fill in departure airport field
        await self.page.wait_for_timeout(1000)
        
    # Select date for departure and return
    async def select_date (self, departure_date, return_date):
        
        departure_date_str = departure_date.strftime("%Y-%m-%d")
        return_date_str = return_date.strftime("%Y-%m-%d")

        departure_locator =  await self.get_element(f"//span[@data-selenium-date='{departure_date_str}']", 10000)
        if departure_locator:
            await departure_locator.click()
        else:
            pytest.fail(f"Departure date '{departure_date_str}' not found!")
        
        return_locator =  await self.get_element(f"//span[@data-selenium-date='{return_date_str}']", 10000)
        if return_locator:
            await return_locator.click()
        else:
            pytest.fail(f" Return date '{return_date_str}' not found!")
        


    async def select_passengers_and_cabin(self, adults=1, children=0, infants=0, cabin="Economy"):
        categories = {
            "adult": adults,
            "children": children,
            "infant": infants
        }

        for category, target_count in categories.items():
            increase_btn = await self.get_element(f"//button[@data-element-name='flight-occupancy-{category}-increase']")
            decrease_btn = await self.get_element(f"//button[@data-element-name='flight-occupancy-{category}-decrease']")
            current_category_locator = await self.get_element(f"//span[@data-component='flight-occupancy-{category}-number']")
            current_count_text = await current_category_locator.text_content()
            current_count = int(current_count_text)

            print(f"Current {category}s: {current_count}, Target: {target_count}")

                # Adjust count
            if target_count > current_count:
                for _ in range(target_count - current_count):
                    await increase_btn.click()
            elif target_count < current_count:
                for _ in range(current_count - target_count):
                    await decrease_btn.click()

        # select cabin class
        cabin_locator = await self.get_element(f"//button[@data-component ='flight-search-cabinClass-{cabin}']")
        if cabin_locator:
            await cabin_locator.click()
        else: 
            pytest.fail("Cannot find cabin classes")
